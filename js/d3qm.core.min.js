function d3QuickMap(){function t(t){return t=t.replace(/,/,"."),!isNaN(parseFloat(t))&&isFinite(t)}d3QuickMap.prototype.drawMap=function(e,n){function a(e,n){if(j.add(k),"us-states"==l?r=topojson.feature(n,n.objects.states).features:"us-counties"==l&&(r=topojson.feature(n,n.objects.counties).features),1==t(j.at(0).get(u))){var a="Lin";L.domain([0,d3.max(k,function(t){return+t[u]})]),q.domain([0,d3.max(k,function(t){return+t[u]})])}else var a="Cat";var s=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){var e=null!=j.get(t.id).get("fullname")?j.get(t.id).get("fullname")+": ":"";return"Lin"==a?'<span class="label">'+e+'</span><span class="value">'+w(j.get(t.id).get(u))+"</span>":'<span class="label">'+e+"</span>"+j.get(t.id).get(u).replace(/\s/g,"")});if(A.call(s),M.selectAll("path").data(r).enter().append("path").attr("d",v).on("mouseover",s.show).on("mouseout",s.hide).attr("class",function(t){return null!=j.get(t.id)?"Lin"==a?q(j.get(t.id).get(u)):j.get(t.id).get(u).replace(/\s/g,""):null}).attr("fill",function(t){return null!=j.get(t.id)?"Lin"==a?L(j.get(t.id).get(u)):D(j.get(t.id).get(u)):null}).attr("id",function(t){return t.id}),"us-counties"==l&&M.append("path").datum(topojson.mesh(n,n.objects.states,function(t,e){return t!==e})).attr("class","states-overlay").attr("d",v).attr("fill","none"),k.forEach(function(t){var e=t[u];null!=e&&""!=e&&(x.hasOwnProperty(e)?x[e]++:x[e]=1)}),p.showLegend===!0){var d=p.type,c=p.showCount;for(var g in x)C.push({name:g,count:x[g]});if("Cat"==a){var f=d3.select("#"+m+" svg").selectAll("svg").data(C).enter().append("g").attr("class","legend-key").attr("cursor","pointer");f.append("rect").attr("x",o/2+10).attr("y",function(t,e){return i/2+i/4+20*e}).attr("width",10).attr("height",10).attr("class",function(t){return t.name.replace(/\s/g,"")}).attr("fill",function(t){return D(t.name)}),f.append("text").attr("x",o/2+25).attr("y",function(t,e){return i/2+i/4+20*e+10}).attr("font-size","11px").text(function(t){var e=c===!0?" ("+t.count+")":"";if("default"==d)return t.name.toUpperCase()+e;if("custom"==d)for(ckey in p.customKeys)if(ckey==t.name.toLowerCase())return p.customKeys[ckey]+e;return null}).on("mouseover",function(t){d3.select(this.parentNode).attr("font-weight","bold"),M.selectAll("path."+t.name).attr("opacity","0.8")}).on("mouseout",function(){d3.select(this.parentNode).attr("font-weight","normal"),M.selectAll("path").attr("opacity","1")})}else if("Lin"==a){var F=d3.max(C,function(t){return+t.name}),b=d3.min(C,function(t){return+t.name});document.getElementById(m+"-tiles").getBoundingClientRect();var y=document.getElementById(m+"-tiles").getBoundingClientRect().left+o*h/2,E=document.getElementById(m+"-tiles").getBoundingClientRect().bottom,f=d3.select("#"+m).append("div").attr("class","legend-scale").attr("style","background-image: linear-gradient(right,"+L(F)+" 35%, #FFFFFF 100%);background-image: -o-linear-gradient(right, "+L(F)+" 35%,#FFFFFF 100%);background-image: -moz-linear-gradient(right, "+L(F)+" 35%, #FFFFFF 100%);background-image: -webkit-linear-gradient(right, "+L(F)+" 35%, #FFFFFF 100%);background-image: -ms-linear-gradient(right, "+L(F)+" 35%, #FFFFFF 100%);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='"+L(F)+"', endColorstr='"+L(b)+"'); -ms-filter: 'progid:DXImageTransform.Microsoft.gradient(startColorstr='"+L(F)+"', endColorstr='"+L(b)+"')';left:"+y+"px; top: "+E+"px;");f.append("span").attr("class","min").text(w(b)),f.append("span").attr("class","max").text(w(F))}}}Config=Backbone.Model.extend({defaults:{w:800,h:600,bm:"us-states",nf:",",cs:"blue",pt:"/d3qm-plugin/"}});var r,s=new Config({w:n.width,h:n.height,bm:n.mapType,ds:n.dataSource,dp:n.dataPoint,nf:n.numberFormat,cs:n.colorScheme,ls:n.legend,pt:n.path}),o=s.get("w"),i=s.get("h"),l=s.get("bm"),d=s.get("ds"),u=s.get("dp"),c=s.get("nf"),g=s.get("cs"),p=s.get("ls"),f=s.get("pt"),m=e,F=946,h=o/F,b=d3.geo.albersUsa(),v=d3.geo.path().projection(b),y=f+"lib/json/us.json",w=d3.format(c),x={},C=[],k=[],E=Backbone.Collection.extend(),j=new E,B={blue:["#EFF3FF","#084594"],red:["#FEE5D9","#99000D"],green:["#EDF8E9","#005A32"],orange:["#FEEDDE","#D94801"],purple:["#F2F0F7","#4A1486"],gray:["#F7F7F7","#252525"]},D=d3.scale.category10(),L=d3.scale.linear().range(B[g]),q=d3.scale.quantize().range(d3.range(9).map(function(t){return"q"+t+"-9"})),A=d3.select("#"+m).append("svg").attr("width",o).attr("height",i).attr("class","d3qmsvg"),M=A.append("g").attr("class","d3qmtiles").attr("id",m+"-tiles").attr("transform","scale("+h+","+h+")");queue().defer(d3.json,y).defer(d3.csv,d,function(t){k.push(t)}).await(a)}}